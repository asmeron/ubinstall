# Инсталляция

#### 1. Запуск инсталлятора.
#### 2. Выводится окно приветствия с лицензионным соглашением.
#### 3. Вывод меню выбора установки редакций операционных систем.

Меню формируется из результатов обработки скрипта, который обходит папки, с редакциями ОС и проверятет в них наличие файлов os-release, получая названия ОС из значения переменной PRETTY_NAME.  
***Структура os-release файла в каталоге (один файл на каталог с редакцией системы):***  
*/UBLinux Server AR.01/os-release*
```
NAME="UBLinux"
ID=ublinux
VARIANT="Server"
VERSION="AR.01"
VERSION_ID="ar.01"
VERSION_CODENAME=andromeda
ID_LIKE=arch
PRETTY_NAME="UBLinux Server AR.01 (Andromeda)"
BUILD_ID="02.10.2019"
ANSI_COLOR="1;34"
HOME_URL="http://ublinux.com/"
```

*/UBLinux Desktop Enterprise AL.02/os-release*
```
NAME="UBLinux"
ID=ublinux
VARIANT="Desktop Enterprise"
VERSION="AL.02"
VERSION_ID="al.02"
VERSION_CODENAME=antlia
ID_LIKE=alpine
PRETTY_NAME="UBLinux Desktop Enterprise AL.02 (Antlia)"
BUILD_ID="02.11.2019"
ANSI_COLOR="1;34"
HOME_URL="http://ublinux.com/"
```

*/UBLinux Desktop Basic DE.03/os-release*
```
NAME="UBLinux"
ID=ublinux
VARIANT="Desktop Basic"
VERSION="DE.03"
VERSION_ID="de.03"
VERSION_CODENAME=apus
ID_LIKE=debian
PRETTY_NAME="UBLinux Desktop Basic DE.03 (Apus)"
BUILD_ID="02.12.2019"
ANSI_COLOR="1;34"
HOME_URL="http://ublinux.com/"
```

*/UBLinux Adara Desktop Enterprise AL.04/os-release*
```
NAME="UBLinux Adara"
ID=ublinux
VARIANT="Desktop Enterprise"
VERSION="AL.04"
VERSION_ID="al.04"
VERSION_CODENAME=aquila
ID_LIKE=alpine
PRETTY_NAME="UBLinux Adara Desktop Enterprise AL.04 (Aquila)"
BUILD_ID="04.10.2019"
ANSI_COLOR="1;31"
HOME_URL="http://ublinux.com/"
```

*/UBLinux Adara Server AR.01/os-release*
```
NAME="UBLinux Adara"
ID=ublinux
VARIANT="Server"
VERSION="AR.01"
VERSION_ID="ar.01"
VERSION_CODENAME=andromeda
ID_LIKE=arch
PRETTY_NAME="UBLinux Adara Server AR.01 (Andromeda)"
BUILD_ID="02.10.2019"
ANSI_COLOR="1;31"
HOME_URL="http://ublinux.com/"
```
Где
> NAME - имя ОС
> ID - идентификатор ОС.  
> VARIANT - редакция ОС.  
> VERSION - версия ОС, две первые буквы указывают на то, на базе какого дистрибутива основана ОС (Ar - Arch Linux, Al - Alpine Linux, De - Debian, Ce - CentOS), последующие цифры указывают на порядковый номер сборки.  
> VERSION_ID - идентификатор версии ос. Тоже самое, что VERSION, но используется только нижний регистр.  
> VERSION_CODENAME - кодовое имя ОС, присваивается произвольно в алфавитном порядке из названий созвездий, звёзд, планет, животных и т.д.  
> ID_LIKE - название дистрибутива, на базе которого основана ОС.  
> PRETTY_NAME - полное название дистрибутива ОС.  
> BUILD_ID - дата сборки дистрибутива ОС в формате "ДД.ММ.ГГГГ".  
> ANSI_COLOR - цвет вывода имени дистрибутива в консоле (формат ANSI color).  
> HOME_URL - домашняя страница пректа.

***Структура каталогов на носителе (локальный):***  
```
| Корень               | Каталог ОС                                  | Файлы                                 | 
|:-------------------- |:------------------------------------------- |:------------------------------------- |
|                      | /UBLinux Desktop Enterprise AL.04           | os-release, key-license, модули ОС    |
|                      |---------------------------------------------|---------------------------------------|
| /                    | /UBLinux Adara Desktop Enterprise AL.04     | os-release, key-license, модули ОС    |
|                      |---------------------------------------------|---------------------------------------|
|                      | /UBLinux Adara Server AR.04                 | os-release, key-license, модули ОС    |
|----------------------|---------------------------------------------|---------------------------------------|
```
В корне накопителя или примонтированного каталога (в случае сетевой установки) содержится каталог или каталоги, доступных для установки, редакций дистрибутивов. Папки имеют названия по имени, версии ОС. Например, UBLinux Adara Server AR.01 (Andromeda). В этих папках кроме файла os-release присутствуют файлы-модули ОС и файл key-license. Файл key-license необходим для процедуры сетевой установки системы и получения обновлений для системы.

### Процедура генерирования лицензионного ключа.
* Запуск генератора. Генератор представляет собой монолитный скрипт с графическим (zenity) или псевдографическим (dialog) интерфейсом.
* Заполняются следующие поля:
  * Владелец лицензии. Текстовое поле. Параметр "org";
  * E-mail. Текстовое поле. Параметр "email";
  * Тип лицензии. Чекбоксы. Параметр "type";
  * Количество лицензий;
  * Дата окончания лицензии для каждого типа лицензии. Элемент календарь или поле ввода. Параметр "date".
* Кнопка "Генерировать".
```
|------------------------------------------------------------------------------|
|                                                                              |
| Владелец лицензии                      |-----------------------------------| |
|                                                                              |
| E-Mail                                 |-----------------------------------| |
|                                                                              |
| |X| UB Linux Desktop Basic,            количество |0000| шт. до |ДД.ММ.ГГГГ| |
| |X| UB Linux Desktop Enterprise,       количество |0000| шт. до |ДД.ММ.ГГГГ| |
| |X| UB Linux Server,                   количество |0000| шт. до |ДД.ММ.ГГГГ| |
|                                                                              |
| |X| UB Linux Adara Desktop Enterprise, количество |0000| шт. до |ДД.ММ.ГГГГ| |
| |X| UB Linux Adara Server,             количество |0000| шт. до |ДД.ММ.ГГГГ| |
|
|
|
```

При нажатии на кнопку "Генерировать" происходит отработка сценария:
Ключ генерируется случайным образом через утилиту uuidgen с параметром r. 

***Структура файла key-license на клиенте:***
```
bb58e360-a00f-4834-9243-c352dc4bd4c5
```

**Если инсталлятор не обнаружил каталогов с ОС и её модулями, происходит соединение с сервером обновлений для запуска процедуры установки системы по сети с локального или удалёненого сервера обновлений.**

### Данные, передающиеся с клиентской машины на сервер:
#### 1. Идентификатор лицензии (данные берутся из файла key-license);
#### 2. Персональный идентификатор (данные берутся из результата выполнения команды hosid на строне клиента).

### Обработка на сервере:
#### 1. Принять данные о лицензии (идентификатор лицензии, персональный идентификатор);
#### 2. Найти по идентификатору лицензии соответствующую запись в json файл-схеме.

***Структура JSON-файла на сервере:***
```
{
"bb58e360-a00f-4834-9243-c352dc4bd4c5":
{
"org": "John Doe",
"email: "john@gmail.com",
"date": "01.01.2020",
"type": "03",
"status": "unactivated",
"hid": ""
},
"62f662f8-a094-418e-9b99-54921b0511bf":
{
"org": "Vasya Pupkin",
"email: "vasyandr@mail.ru",
"date": "01.01.2025",
"type": "02",
"status": "unactivated",
"hid": ""
},
"2e97d29a-dd50-49d3-9436-981e57125d49":
{
"org": "Tobias Boon",
"email: "noob_saibot@gmail.com",
"date": "01.01.2022",
"type": "11",
"status": "unactivated",
"hid": ""
},
"e213effb-25d3-42c0-86a8-ffa0d029675b":
{
"org": "To Yama To Kanawa",
"email: "komu-to_herovato@sunhun.jp",
"date": "01.01.2030",
"type": "12",
"status": "unactivated",
"hid": ""
}
}
```
Где
> * "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX" - ключ лицензии, сгенерированный случайным образом;
> * "org" - название организации, владельца лицензии;
> * "email" - почтовый ящик, зарегистрированный для обращений в службу поддержки;
> * "date" - Дата окончания срока действия лицензии (дата окончания срока поддержки в формате ДД.ММ.ГГГГ);
> * "type" - код типа лицензии (Server, Enterprise, Basic или их комбинации).
>   * 01 - UBLinux Desktop Basic
>   * 02 - UBLinux Desktop Enterpise
>   * 03 - UBLinux Server
>   * 11 - UBLinux Adara Desktop Enterpise
>   * 12 - UBLinux Adara Server
> * "status" - статус активации (activated - активировано, unactivated - деактивировано)
> * "hid" - персональный идентификатор рабочего места или сервера с активированной системой (hostid)

#### 3. Извлечь данные:
  * дата окончания лицензии;
  * тип лицензии;
  * статус активации;
  * персональный идентификатор.
#### 4. Если дата окончания лицензии пройдена, формируем ответ клиенту, в котором содержится отказ;
  * В интерфейсе инсталлятора выводится сообщение "Срок действия поддержки истёк. Обратитесь в службу поддержки".
#### 5. Если статус активации равен "activated", сравниваем значения данных hostid со значением параметра hid в файл-схеме json.
  * Если значения разные формируем ответ клиенту, в котором содержится отказ;
  * В интерфейсе инсталлятора выводится сообщение "Данный лицензионный ключ уже используется на другом рабочем месте или сервере! Обратитесь в службу поддержки".
#### 6. Если статус активации равен "unactivated", формируем ответ клиенту, в котором содержится предупреждение;
  * В интерфейсе инсталлятора выводится сообщение "Необходимо пройти процедуру активации системы для получения обновлений и поддержки!".
  * Запускается ***процедура активации***.
  * После прохождения процедуры активации происходит повтор работы алгоритма с п.4.
#### 7. Проверяем, какие типы лицензий доступны;
Доступные типы лицензии берутся из значений "type".
#### 8. Запускается *процедура формирования каталога репозитория и ответа клиенту*, в котором содержатся данные для доступа к репозиторию.

### Процедура формирования каталога репозитория и ответа клиенту
* Сервер создаёт у себя в корневом каталоге repository папку с именем ключа лицензии клиента;
* В этот каталог символическими ссылками подключаются каталоги (имеют названия по имени, версии ОС. Например, UBLinux Adara Server AR.01 (Andromeda). Данные берутся из файла os-release) доступных для установки клиенту систем;
* Отправка ответа клиенту.

Ответ содержит информацию и параметры того, какой каталог необходимо примонтировать с сервера посредствам протокола SFTP (путь, логин, пароль).

***Структура каталогов репозитория на сервере:***  
```
| Корень          | Глобальная редакция  | Редакция           | Основа | Версия       |
|:--------------- |:-------------------- |:------------------ |:------ |:-------------| 
|                 |                      |                    |        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AR    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | /..          |
|                 |                      |                    |--------|--------------|
|                 |                      | /Desktop Basic     |        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AL    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | /..          |
|                 |                      |                    |--------|--------------|
|                 |                      |                    | /..    | /..          |
|                 |                      |--------------------|--------|--------------|
|                 |                      |                    |        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AR    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | /..          |
|                 |                      |                    |--------|--------------|
|                 | /UBLinux             | /Desktop Enterprise|        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AL    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | /..          |
|                 |                      |                    |--------|--------------|
|                 |                      |                    | /..    | /..          |
|                 |                      |--------------------|--------|--------------|
|                 |                      |                    |        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AR    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | ..           |
|                 |                      |                    |--------|--------------|
|                 |                      | /Server            |        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AL    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | /..          |
| /all_repository |                      |                    |--------|--------------|
|                 |                      |                    | /..    | /..          |
|                 |----------------------|--------------------|--------|--------------|
|                 |                      |                    |        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AR    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | /..          |
|                 |                      |                    |--------|--------------|
|                 |                      | /Desktop Enterprise|        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AL    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | /..          |
|                 |                      |                    |--------|--------------|
|                 |                      |                    | /..    | /..          |
|                 | /UBLinux Adara       |--------------------|--------|--------------|
|                 |                      |                    |        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AR    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | /..          |
|                 |                      |                    |--------|--------------|
|                 |                      | /Server            |        | /01          |
|                 |                      |                    |        |--------------|
|                 |                      |                    | /AL    | /02          |
|                 |                      |                    |        |--------------|
|                 |                      |                    |        | /..          |
|                 |                      |                    |--------|--------------|
|                 |                      |                    | /..    | /..          |
|                 |----------------------|--------------------|--------|--------------|
|                 | /..                  | /..                | /..    | /..          |
|-----------------|----------------------|--------------------|--------|--------------|
```
В корне накопителя содержится каталог all_repository, доступных для установки, редакций дистрибутивов. В этом каталоге содержатся субкаталоги с редакциями и версиями ОС. В папках с версиями располагаются файлы os-release, модули ОС.

***Структура каталогов репозитория на сервере, сформированного для обновления клиенту:***  
```
| Корень               | Каталог ОС                                  | Файлы                                 | 
|:-------------------- |:------------------------------------------- |:------------------------------------- |
|                      | /UBLinux Desktop Enterprise AL.04           | os-release, модули ОС                 |
|                      |---------------------------------------------|---------------------------------------|
| /repository          | /UBLinux Adara Desktop Enterprise AL.04     | os-release, модули ОС                 |
|                      |---------------------------------------------|---------------------------------------|
|                      | /UBLinux Adara Server AR.04                 | os-release, модули ОС                 |
|----------------------|---------------------------------------------|---------------------------------------|
```
